# Use the latest 2.1 version of CircleCI pipeline process engine.
# See: https://circleci.com/docs/configuration-reference
version: 2.1

commands:
  decrypt-keystore:
    steps:
      - run:
          name: Decrypt Keystore
          command: |
            echo -e "$ANDROID_KEYSTORE_PATH" | base64 -di > "$ANDROID_KEYSTORE_BASE64"
  install-jdk:
    steps:
      - run:
          name: JDK 17 Install
          command: |
            sudo apt-get update && sudo apt-get install openjdk-17-jdk
            sudo update-alternatives --set java /usr/lib/jvm/java-17-openjdk-amd64/bin/java
            sudo update-alternatives --set javac /usr/lib/jvm/java-17-openjdk-amd64/bin/javac
            java -version
            echo 'export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64' >> $BASH_ENV
            export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64
  submodule-update:
    steps:
      - run:
          name: Submodule update
          command: |
            git submodule update --init

jobs:
  share-env-vars:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      - install-jdk
      - run:
          name: Check Git Message and Set RUN_E2E
          command: |
            #!/usr/bin/env bash
            set -e
            set -o pipefail
            set -x

            echo "$CIRCLE_SHA1" # Prints the commit SHA
            # verify your needed variable here
            echo "$CIRCLE_COMPARE_URL"

            if [[ "$CIRCLE_SHA1" == *"Run E2E test suite"* ]]; then
              echo "RUN_E2E=true" >> $BASH_ENV
            fi
      - run:
          name: Print RUN_E2E for Debug
          command: | 
              echo "RUN_E2E is set to: $RUN_E2E"
  
  build-qa-debug:
    machine:
      image: android:2024.04.1
    resource_class: xlarge
    environment:
      ANDROID_KEYSTORE_PATH: "$KEYSTORE_PATH"
      ANDROID_KEYSTORE_BASE64: "$KEYSTORE_BASE64"
    working_directory: ~/project/apps
    steps:
      - checkout:
          path: ~/project
      - install-jdk
      - decrypt-keystore
      - submodule-update
      - run:
          name: Build QaDebug with Gradle
          command: ../gradle/gradlew :student:assembleQaDebug :student:assembleQaDebugAndroidTest
      - store_artifacts:
          path: ./student/build/outputs/apk/qa/debug/student-qa-debug.apk
          destination: APP_QA_DEBUG
      - store_artifacts:
          path: ./student/build/outputs/apk/androidTest/qa/debug/student-qa-debug-androidTest.apk
          destination: TEST_QA_DEBUG
      - persist_to_workspace:
          root: ~/project/apps/student
          paths:
            - ./build/outputs/apk/qa/debug/student-qa-debug.apk
            - ./build/outputs/apk/androidTest/qa/debug/student-qa-debug-androidTest.apk
  
  build-and-comment-dev-debug-minify:
    machine:
      image: android:2024.04.1
    resource_class: xlarge
    environment:
      ANDROID_KEYSTORE_PATH: "$KEYSTORE_PATH"
      ANDROID_KEYSTORE_BASE64: "$KEYSTORE_BASE64"
      ANDROID_KEYSTORE_PASSWORD: "$ANDROID_KEYSTORE_PASSWORD"
      DEBUG_KEY_ALIAS: "$DEBUG_KEY_ALIAS"
      DEBUG_KEY_PASSWORD: "$DEBUG_KEY_PASSWORD"
    working_directory: ~/project/apps
    steps:
      - checkout:
          path: ~/project
      - install-jdk
      - decrypt-keystore
      - submodule-update

      - run:
          name: DEBUG
          command: echo $ANDROID_KEYSTORE_PATH

      - run:
          name: Build DevDebugMinify with Gradle
          command: |
            ../gradle/gradlew :student:assembleDevDebugMinify --build-cache --stacktrace \
              -Pandroid.injected.signing.store.file="$ANDROID_KEYSTORE_PATH" \
              -Pandroid.injected.signing.store.password="$ANDROID_KEYSTORE_PASSWORD" \
              -Pandroid.injected.signing.key.alias="$DEBUG_KEY_ALIAS" \
              -Pandroid.injected.signing.key.password="$DEBUG_KEY_PASSWORD"     
      - run:
          name: Comment on PR with Build Details
          command: |
            if [ -n "$CIRCLE_PULL_REQUEST" ]; then
              curl -X POST -H "Authorization: token $GITHUB_TOKEN" \
                -d '{"body": "DevDebugMinify build completed successfully."}' \
                "https://api.github.com/repos/your_org/your_repo/issues/${CIRCLE_PULL_REQUEST##*/}/comments"
            fi

  unit-tests:
    machine:
      image: android:2024.04.1
    resource_class: xlarge
    environment:
      ANDROID_KEYSTORE_PATH: "$KEYSTORE_PATH"
      ANDROID_KEYSTORE_BASE64: "$KEYSTORE_BASE64"
    working_directory: ~/project/apps
    steps:
      - checkout:
          path: ~/project
      - install-jdk
      - decrypt-keystore
      - submodule-update
      - run:
          name: Run Android Unit Tests
          command: |          
            ../gradle/gradlew :student:testDevDebugUnitTest
      - store_test_results:
          path: ./student/build/test-results/testDevDebugUnitTest
      - store_artifacts:
          path: ./student/build/reports/tests/testDevDebugUnitTest

  ui-tests:
    machine:
      image: android:2024.04.1
    resource_class: xlarge
    environment:
      ANDROID_KEYSTORE_PATH: "$KEYSTORE_PATH"
      ANDROID_KEYSTORE_BASE64: "$KEYSTORE_BASE64"
      APP_APK_PATH: "./student/build/outputs/apk/qa/debug/student-qa-debug.apk"
      TEST_APK_PATH: "./student/build/outputs/apk/androidTest/qa/debug/student-qa-debug-androidTest.apk"
    working_directory: ~/project/apps
    steps:
      - checkout:
          path: ~/project
      - attach_workspace:
          at: ~/project/apps/student
      - install-jdk
      - run:
          name: Download flank
          command: |
            wget --quiet https://github.com/Flank/flank/releases/download/v23.10.1/flank.jar -O ./flank.jar
      - run:
          command: |
            echo $GCLOUD_SERVICE_ACCOUNT_JSON > /tmp/google_service_account.json
            export GOOGLE_APPLICATION_CREDENTIALS=/tmp/google_service_account.json
            gcloud auth activate-service-account  --key-file=/tmp/google_service_account.json
            gcloud config set project delta-essence-114723
            java -jar ./flank.jar firebase test android run -c ./student/flank.yml
          name: Integration Tests
      - store_test_results:
          path: ./results


workflows:
  pr-workflow:
    jobs:
      - share-env-vars
      - build-qa-debug:
          requires: [share-env-vars]
      - unit-tests:
          requires: [share-env-vars]
      - ui-tests:
          requires: [build-qa-debug]
