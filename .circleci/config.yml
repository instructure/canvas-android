version: 2.1

commands:
  decrypt-keystore:
    steps:
      - run:
          name: Decrypt Keystore
          command: |
            echo $KEYSTORE_BASE64 | base64 --decode > $ANDROID_KEYSTORE_PATH
  install-jdk:
    steps:
      - run:
          name: JDK 17 Install
          command: |
            sudo apt-get update && sudo apt-get install openjdk-17-jdk
            sudo update-alternatives --set java /usr/lib/jvm/java-17-openjdk-amd64/bin/java
            sudo update-alternatives --set javac /usr/lib/jvm/java-17-openjdk-amd64/bin/javac
            java -version
            echo 'export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64' >> $BASH_ENV
            export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64
  submodule-update:
    steps:
      - run:
          name: Submodule update
          command: |
            git submodule update --init
  download-flank:
    steps:
      - run:
          name: Download flank
          command: |
            wget --quiet https://github.com/Flank/flank/releases/download/v23.10.1/flank.jar -O ./flank.jar
  flank:
    parameters:
      title:
        default: UI tests
        type: string
      flank-yml:
        default: ./apps/student/flank.yml
        type: string
    steps:
      - run:
          command: |
            echo $GCLOUD_SERVICE_ACCOUNT_JSON > /tmp/google_service_account.json
            export GOOGLE_APPLICATION_CREDENTIALS=/tmp/google_service_account.json
            gcloud auth activate-service-account  --key-file=/tmp/google_service_account.json
            gcloud config set project delta-essence-114723
            java -jar ./flank.jar firebase test android run -c << parameters.flank-yml >>
          name: << parameters.title >> 


jobs:
  share-env-vars:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      - install-jdk
      - run:
          name: Check Git Message and Set RUN_E2E
          command: |
            #!/usr/bin/env bash
            set -e
            set -o pipefail
            set -x

            echo "$CIRCLE_SHA1" # Prints the commit SHA
            # verify your needed variable here
            echo "$CIRCLE_COMPARE_URL"

            if [[ "$CIRCLE_SHA1" == *"Run E2E test suite"* ]]; then
              echo "RUN_E2E=true" >> $BASH_ENV
            fi
      - run:
          name: Print RUN_E2E for Debug
          command: | 
              echo "RUN_E2E is set to: $RUN_E2E"
  
  build-qa-debug:
    machine:
      image: android:2024.04.1
    resource_class: xlarge
    working_directory: ~/project/apps
    steps:
      - checkout:
          path: ~/project
      - install-jdk
      - decrypt-keystore
      - submodule-update
      - run:
          name: Build QaDebug with Gradle
          command: ../gradle/gradlew :student:assembleQaDebug :student:assembleQaDebugAndroidTest
      - store_artifacts:
          path: ./student/build/outputs/apk/qa/debug/student-qa-debug.apk
          destination: APP_QA_DEBUG
      - store_artifacts:
          path: ./student/build/outputs/apk/androidTest/qa/debug/student-qa-debug-androidTest.apk
          destination: TEST_QA_DEBUG
      - persist_to_workspace:
          root: ~/project/apps/student
          paths:
            - ./build/outputs/apk/qa/debug/student-qa-debug.apk
            - ./build/outputs/apk/androidTest/qa/debug/student-qa-debug-androidTest.apk
  
  build-and-comment-dev-debug-minify:
    machine:
      image: android:2024.04.1
    resource_class: xlarge
    environment:
      ANDROID_KEYSTORE_PATH: /home/circleci/project/keystore.jks
    working_directory: ~/project/apps
    steps:
      - checkout:
          path: ~/project
      - install-jdk
      - decrypt-keystore
      - submodule-update
      - run:
          name: Build DevDebugMinify with Gradle
          command: |
            ../gradle/gradlew :student:assembleDevDebugMinify --build-cache \
              -Pandroid.injected.signing.store.file=$ANDROID_KEYSTORE_PATH \
              -Pandroid.injected.signing.store.password=$ANDROID_KEYSTORE_PASSWORD \
              -Pandroid.injected.signing.key.alias=$DEBUG_KEY_ALIAS \
              -Pandroid.injected.signing.key.password=$DEBUG_KEY_PASSWORD
      - run:
          name: Install Firebase CLI
          command: |
            curl -sL https://firebase.tools | bash
      - run:
          name: Deploy APK to Firebase App Distribution
          command: |
            echo "$GOOGLE_APPLICATION_CREDENTIALS_JSON" > /tmp/service-account.json
            export GOOGLE_APPLICATION_CREDENTIALS=/tmp/service-account.json
            OUTPUT=$(firebase appdistribution:distribute ./student/build/outputs/apk/dev/debugMinify/student-dev-debugMinify.apk \
             --app $STUDENT_APP_ID \
             --groups "testers")
            SHARE_URI=$(echo "$OUTPUT" | grep -oP 'Share this release with testers who have access: \Khttps://.*')
            echo "export SHARE_URI=\"$SHARE_URI\"" >> "$BASH_ENV"
      - run:
          name: Comment on PR with Build Details
          command: |
            if [ -n "$CIRCLE_PULL_REQUEST" ]; then
              COMMENT="DevDebugMinify build completed successfully: $SHARE_URI"
              curl -X POST -H "Authorization: token $GITHUB_TOKEN" \
                -d "{\"body\": \"$COMMENT\"}" \
                "https://api.github.com/repos/instructure/canvas-android/issues/${CIRCLE_PULL_REQUEST##*/}/comments"
            fi

  unit-tests:
    machine:
      image: android:2024.04.1
    resource_class: xlarge
    working_directory: ~/project/apps
    steps:
      - checkout:
          path: ~/project
      - install-jdk
      - decrypt-keystore
      - submodule-update
      - run:
          name: Run Android Unit Tests
          command: |
            ../gradle/gradlew :student:testDevDebugUnitTest
      - store_test_results:
          path: ./student/build/test-results/testDevDebugUnitTest
      - store_artifacts:
          path: ./student/build/reports/tests/testDevDebugUnitTest

  ui-tests-portrait:
    machine:
      image: android:2024.04.1
    resource_class: xlarge
    working_directory: ~/project
    steps:
      - checkout:
          path: ~/project
      - attach_workspace:
          at: ~/project/apps/student
      - download-flank
      - flank:
          title: UI tests portrait
          flank-yml: ./apps/student/flank.yml
      - store_test_results:
          path: ./results

  ui-tests-landscape:
    machine:
      image: android:2024.04.1
    resource_class: xlarge
    working_directory: ~/project
    steps:
      - checkout:
          path: ~/project
      - attach_workspace:
          at: ~/project/apps/student
      - download-flank
      - flank:
          title: UI tests landscape
          flank-yml: ./apps/student/flank_landscape.yml
      - store_test_results:
          path: ./results

  ui-tests-tablet:
    machine:
      image: android:2024.04.1
    resource_class: xlarge
    working_directory: ~/project
    steps:
      - checkout:
          path: ~/project
      - attach_workspace:
          at: ~/project/apps/student
      - download-flank
      - flank:
          title: UI tests tablet
          flank-yml: ./apps/student/flank_tablet.yml
      - store_test_results:
          path: ./results


workflows:
  pr-workflow:
    jobs:
      - share-env-vars
      - build-and-comment-dev-debug-minify:
          requires: [share-env-vars]
#      - build-qa-debug:
#          requires: [share-env-vars]
#      - unit-tests:
#          requires: [share-env-vars]
#      - ui-tests-portrait:
#          requires: [build-qa-debug]
#      - ui-tests-landscape:
#          requires: [build-qa-debug]
#      - ui-tests-tablet:
#          requires: [build-qa-debug]